План занятия:
- Микросервисы и их особенности
- Структура типичного микросервиса
- Управление конфигурацией
- Журналирование
- Мониторинг, трассировка, отладка
___
<h5>Микросервисы</h5>
Источники информации:
- https://microservices.io/
- https://martinfowler.com/microservices/
- Книга **Microservices Patterns** by Chris Richardson
- Книга **Building Microservices: Designing Fine-Grained Systems** by Sam Newman

**Микросервисы** — обычные сетевые приложения, реализующие одну или несколько связанных функций.

"Микро" в названии микросервисы относится именно к ограниченной функциональности, а не к объёму кодовой базы и требованиям к ресурсам оборудования.

Микросервисная архитектура приложения — структура информационной системы в виде набора отдельных микросервисов, взаимодействующих по сети.

P.S. Микросервисная всё-таки не архитектура, а топология. Хотя термин "микросервисная архитектура" уже устоялся.
<h6>Особенности микросервисов</h6>
Особенности микросервисов:
- Ограниченная функциональность ("crawler", "index", "engine", "пользователи", "orders", и тд)
- Отсутствие состояния (микросервис не хранит состояния клиентских запросов)
- Отдельная БД для каждого микросервиса, т.е. недопустимы общие БД для нескольких микросервисов
- Наличие систем централизованного сбора журналов и трассировки
- Наличие стабильного задокументированного API,
- Динамическая среда развёртывания
- Синхронное или асинхронное взаимодействие

P.S. Какое преимущество даёт отсутствие состояния? Легкое горизонтальное масштабирование! :3
___
<h5>Структура типичного микросервиса</h5>
Микросервис — обычное сетевое приложение, имеющее стандартную структуру.
Типовые компоненты микросервиса:
- Исполняемый пакет
- API
- Пакет для работы с БД
- Пакет для работы с очередью сообщений
- Пакеты с бизнес-логикой

Обычно микросервис объявляет некоторых верхнеуровневый тип данных — "сервер" или "служба", который содержит все требуемые зависимости: объект API, подключение к БД, драйвер очереди, сущности бизнес-логики и т.д.

Объект "сервер" обычно инициализирует все подсистемы микросервиса и запускает циклы обработки запросов или сообщений из очереди и прочих источников.

![[Pasted image 20240804194744.png]]
___
<h5>Управление конфигурацией</h5>
Большинству микросервисов для работы требуется конфигурация, в которой могут храниться следующие элементы:
- Адреса других микросервисов
- Адреса серверов инфраструктуры: БД, очереди и т.д.
- Адреса внешних ИС: платёжные системы, почтовые серверы и т.д.
- Учётные данные
- Параметры работы: имя службы, имя сервера, режим работы (тестовый, рабочий), уровень журналирования (debug, info, error) и т.д.
- Часть параметров может быть доступна только после авторизации
- Конфигурация должна быть доступна в динамической среде

Один из известных пакетов для управления конфигурацией — Viper (золотой стандарт).

Варианты размещения конфигурации:
- Переменные окружения
- Файл (JSON, TOML, XML и т.д.)
- Kubernetes ConfigMap & Secert
- Специализированное ПО: 
  HashiCorp Consul https://www.consul.io/
  HashiCorp Vault https://www.vaultproject.io/

Иногда следует разделять хранение открытых и секретных параметров конфигурации.

Источник конфигурации должен быть доступен для обнаружения микросервисом, то есть либо конфигурация должна быть доставлена микросервису средой выполнения (vSphere, Kubernetes и т.д.), либо размещена в сети по известному адресу.
___
<h5>Журналы операций</h5>
Распределённый характер микросервисного приложения требует журналирования всех операций в каждом приложении.

Часто в среде виртуализации микросервис пишет сообщения об операциях в консоль, откуда все записи копируются на централизованный сервер сборки журналов, где их можно просмотреть и выполнить по ним поиск.

Чаще всего для этих задач используется ELK https://www.elastic.co/

При записи в журнал используется "структурное логирование".
___
<h5>Мониторинг, трассировка, отладка</h5>
<h6>Мониторинг</h6>
**Мониторинг** — процесс сбора информации о параметрах работы системы в реальном времени.

Мониторинг может быть внешним и внутренним (инструментирование).

Внешний мониторинг — задача DevOps или системных администраторов.

Поддержка мониторинга внутренних параметров работы системы — задача программиста, заключающаяся в добавлении в код приложения метрик производительности.

Метрики — разного рода счётчики, с помощью которых можно считать количество обслуженных запросов, количество ошибок, среднее время выполнения операций и т.д.

Чаще всего для мониторинга используют ПО Prometheus:
https://prometheus.io/docs/guides/go-application/#instrumenting-a-go-application-for-prometheus

Прометей имеет отличную поддержку Go и предоставляет три вида метрик: счётчики, индикаторы и гистограммы.

![[Pasted image 20240804221606.png]]
<h6>Трассировка</h6>
**Трассировка** распределённого приложения предполагает замеры времени выполнения запроса по всему пути следования через микросервисы.

Для идентификации каждого запроса в разных микросервисах, запросу присваивается уникальный идентификатор (UUID), который сохраняется на всём пути обработки запроса.

Идентификатор передаётся между микросервисами с помощью метаданных запроса.

Все замеры времени так же привязываются к идентификатору запроса.

Например, пользователь пишет: "Ребята, товар добавляется в корзину целых 5 секунд!". Мы должны понять, в чём проблема, и для этого мы можем осуществить трассировку запроса пользователя.

Для распределённой трассировки чаще всего используется ПО, поддерживающее протокол "Open Telemetry" ("Open Tracing"): https://opentelemetry.io/

Самое популярное такое ПО — Jaeger: https://www.jaegertracing.io/

![[Pasted image 20240804221635.png]]
<h6>Отладка</h6>
**Отладка** распределённого приложения предполагает совместный запуск нескольких микросервисов на компьютере разработчика.

Обычно для этого разработчик использует оркестраторы контейнеров (Docker-compose, Kubernetes) для запуска требуемых микросервисов и элементов инфраструктуры: баз данных, серверов конфигурации, очередей и т.д.

Отладка распределённого приложения сложна и чаще всего необходимо локализовать проблему на уровне конкретного микросервиса.
___
<h5>Kubernetes</h5>
**Kubernetes** — программное обеспечение, позволяющее создать из нескольких серверов облако, где приложения выполняются в контейнерах.

В кубере микросервисы обычно запускаются в нескольких экземплярах в рамках Deployment или StatefulSet.

Поскольку у МС нет состояния, их удобно горизонтально масштабировать. Кубер позволяет изменять количество экземпляров приложения на ходу.

Можно использовать объект Service для организации сетевого доступа и балансировки запросов к приложению.

Для кубера используется декларативный стиль описания конечного состояния. Обычно целевое состояние описывается в виде yaml-файлов.