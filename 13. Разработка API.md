План занятия:
- Понятие API
- REST API
- Middleware
- Тестирование API
- Пакет API
- Контекст в HTTP-обработчиках
- Авторизация
- Документирование API
___
<h5>Понятие API</h5>
![[Без имени-1.png]]

Для общения клиента с нашей системой, а также для общения микросервисов нашей системы между собой используется API. Каждый микросервис предоставляет API, предлагающий способы обращения к себе.

Кроме того, обычно существует отдельный компонент — API Gateway, являющийся точкой входа запроса клиента внешней системы в нашу систему.

**API (application programming interface, программный интерфейс приложения)** — описание способов (наборов классов, процедур, функций, структур или констант), которыми одна компьютерная программа может взаимодействовать с другой программой (*Википедия*).

API — единственный способ взаимодействия с приложением. API может существовать на уровне приложения, пакета, подсистемы, базы данных (схема БД) и прочего. Целью нашего изучения является API на уровне приложения.

API приложения служит двум основным целям:
- Взаимодействие с внешними системами (доступен снаружи) — **public API**
- Предоставление данных клиентским приложениям (нашим веб-, мобильные приложения) (доступен только изнутри системы) — **private API**
___
<h5>REST API</h5>
**REST** (Representational State Transfer — «передача состояния представления») — _архитектурный стиль взаимодействия компонентов распределённого приложения в сети._ Взаимодействие между сервером и клиентом представляет собой HTTP-запрос, где необходимые данные передаются в качестве параметров запроса, причем в том же виде, что и сами данные.

### Принципы REST и RESTful приложений:

1. **Клиент-серверная архитектура**.
2. **Отсутствие состояния**. Все запросы от клиента должны быть составлены так, чтобы сервер получил всю необходимую информацию для выполнения запроса, чтобы и сервер, и клиент могли "понимать" любое сообщение, не опираясь при этом на предыдущие сообщения.
3. **Кэширование**. Клиенты могут выполнять кэширование ответов сервера. У тех, в свою очередь, должно быть явное или неявное обозначение как кэшируемых или некэшируемых, чтобы клиенты в ответ на последующие запросы не получали устаревшие или неверные данные. Правильное использование кэширования помогает полностью или частично устранить некоторые клиент-серверные взаимодействия, ещё больше повышая производительность и расширяемость системы.
4. **Единообразие интерфейса**. Должен существовать определённый интерфейс, с помощью которого клиент будет всегда понимать, в каком формате и на какие адреса ему нужно слать запрос, а сервер, в свою очередь, понимать, в каком формате ему следует отвечать на запросы клиента.
5. **Слои**. Под слоями подразумевается иерархическая структура сетей. Иногда клиент может общаться напрямую с сервером, а иногда — просто с промежуточным узлом. Применение промежуточных серверов способно повысить масштабируемость за счёт балансировки нагрузки и распределённого кэширования.
6. **Код по требованию** (необязательное ограничение). Клиент может расширять свою функциональность, за счет загрузки кода с сервера в виде апплетов или сценариев.

В современном представлении, REST API состоит из следующих компонентов:
- Клиент-серверная архитектура;
- Протокол HTTP для взаимодействия клиента и сервера;
- Набор конечных точек API, определённых с помощью адреса, параметров и методов (глаголов) HTTP;
- Схема именования: коллекция — ресурс;
- Маршрутизатор запросов;
- Набор промежуточного ПО (middleware);
- Сериализация данных в формате JSON (реже XML);
- Клиент — браузер, мобильное приложение, другой сервис и т.д.

Протокол HTTP имеет 6 основных типов методов, каждый из которых предназначен для определённого действия:
- **GET** — получить данные;
- **POST** — создать запись;
- **OPTIONS** — получить заголовки и возможные команды;
- **PUT** — заменить (обновить полностью);
- **PATCH** — обновить частично;
- **DELETE** — удалить.
Поскольку смысл этих глаголов размыт и общепринятых схем нет, то выбор методов HTTP для эндпоинтов API остаётся на усмотрение разработчика / соглашений в команде / усмотрение аналитика / ...

<h6>Схема именования</h6>
Крайне важным является разработка схемы имён эндпоинтов API. Имена должны быть понятны и логичны, соответствовать REST'у.

Нужно принять следующие решения:
- используемые методы HTTP
- версионирование API
- различные схемы для public/private
- имена для действий (new, delete, ...) или их отсутствие
- формат ответов, сопоставление ошибок и кодов ответа HTTP

Пример:
- `GET /api/private/v2/books/{id}`
- `POST /api/private/v2/books`
- `DELETE /api/private/v2/books/{id}`

Необходимо также решить, как передавать параметры: в query path (`../type/books/23`), в виде query params (`?type=books`) или в теле запроса (`{"type": "books"}`).
___
<h5>Middleware</h5>
**Middleware** (посредник, обёртка) — функция, которая вызывается для каждого HTTP-запроса и предназначена для выполнения системных задач (не бизнес-логика).

Примеры задач, выполняемых middleware: авторизация, журналирование запросов, поддержка активной сессии и т.д.

Посредник принимает в качестве аргумента обработчик запроса и возвращает также обработчик.

Логика работы посредника: вернуть функцию обработчик, которая:
1. Каким-либо образом обрабатывает запрос
2. Передаёт управление следующему обработчику (взятому из аргумента функции-middleware)

```go
func middleware(next http.Handler) http.Handler {  
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {  
       log.Println("Middleware: Пришёл запрос")  
       next.ServeHTTP(w, r)  
    })  
}
```

